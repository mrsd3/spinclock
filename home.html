<!--
‚úÖ MODULE HORLOGES : Cr√©er des s√©quences de cat√©gories et les affecter par jour/heure
‚úÖ COMPTEUR DE TITRES : Affichage du nombre de titres par horloge
‚úÖ ACCORDION : R√©duction/expansion des horloges pour une meilleure lisibilit√©
‚úÖ AFFECTATION RAPIDE : Affecter une horloge √† toute la grille ou par jour
üìÖ 3 novembre 2025 ‚Äî Martial Demots ‚Äî V3.0.3
-->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Simulateur de rotations ‚Äî V3.0.3</title>
  
  <!-- Cloudflare Web Analytics -->
  <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "REMPLACE_PAR_TON_TOKEN"}'></script>
  <!-- End Cloudflare Web Analytics -->
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    :root{
      --primary:#3b82f6;--primary-dark:#2563eb;--primary-light:#60a5fa;
      --success:#10b981;--warning:#f59e0b;--danger:#ef4444;
      --bg:#0f172a;--surface:#1e293b;--surface-light:#334155;
      --text:#f1f5f9;--text-muted:#94a3b8;--border:#475569;
      --cat-P:#8b5cf6;--cat-A:#ef4444;--cat-B:#10b981;--cat-C:#ffa201;--cat-D:#ec4899;--cat-E:#6366f1;
      --cat-S:#4490c0;--cat-R:#f97316;--cat-G:#a855f7;--cat-H:#06b6d4;--cat-I:#84cc16;--cat-J:#f43f5e;
      --cat-K:#a698c8;--cat-L:#06b6d4;--cat-M:#10b981;--cat-N:#a8c32e;--cat-O:#ec4899;--cat-Q:#6366f1;
      --cat-T:#14b8a6;--cat-U:#f97316;--cat-V:#a855f7;--cat-W:#84cc16;--cat-X:#f43f5e;--cat-Y:#8b5cf6;--cat-Z:#06b6d4;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%);color:var(--text);font-family:'Inter',ui-sans-serif,system-ui,-apple-system,sans-serif;min-height:100vh;padding:20px}
    .container{max-width:1600px;margin:0 auto}
    .header{background:linear-gradient(135deg,var(--primary-dark),var(--primary));border-radius:20px;padding:32px;margin-bottom:24px;box-shadow:0 20px 60px rgba(59,130,246,0.3);position:relative;overflow:hidden}
    .header::before{content:'';position:absolute;top:0;right:0;width:300px;height:300px;background:radial-gradient(circle,rgba(255,255,255,0.1),transparent);border-radius:50%;transform:translate(50%,-50%)}
    .header-content{position:relative;z-index:1}
    h1{font-size:clamp(28px,4vw,42px);font-weight:800;letter-spacing:-0.02em;margin-bottom:8px;background:linear-gradient(135deg,#fff,rgba(255,255,255,0.8));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .version{display:inline-block;background:rgba(255,255,255,0.2);color:#fff;padding:4px 12px;border-radius:20px;font-size:13px;font-weight:700;cursor:pointer;transition:all 0.3s;backdrop-filter:blur(10px)}
    .version:hover{background:rgba(255,255,255,0.3);transform:translateY(-2px)}
    .subtitle{color:rgba(255,255,255,0.9);font-size:15px;margin-top:12px;line-height:1.6}
    .tabs{display:flex;gap:8px;margin-bottom:24px;background:var(--surface);padding:8px;border-radius:16px;border:1px solid var(--border);overflow-x:auto}
    .tab{flex:1;min-width:140px;padding:12px 20px;background:transparent;color:var(--text-muted);border:none;border-radius:12px;font-weight:600;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:8px;white-space:nowrap}
    .tab:hover{background:var(--surface-light);color:var(--text)}
    .tab.active{background:var(--primary);color:#fff;box-shadow:0 4px 12px rgba(59,130,246,0.4)}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:16px;overflow:hidden;margin-bottom:20px;box-shadow:0 4px 20px rgba(0,0,0,0.3);transition:transform 0.3s,box-shadow 0.3s}
    .card:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(0,0,0,0.4)}
    .card-header{background:var(--surface-light);padding:20px 24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
    .card-title{font-size:18px;font-weight:700;display:flex;align-items:center;gap:10px}
    .card-body{padding:24px}
    .btn{appearance:none;border:none;border-radius:10px;padding:10px 20px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.3s;display:inline-flex;align-items:center;gap:6px}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-primary:hover{background:var(--primary-dark);transform:translateY(-2px);box-shadow:0 6px 20px rgba(59,130,246,0.4)}
    .btn-secondary{background:var(--surface-light);color:var(--text);border:1px solid var(--border)}
    .btn-secondary:hover{background:var(--border);transform:translateY(-2px)}
    .btn-secondary.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-danger:hover{background:#dc2626;transform:translateY(-2px);box-shadow:0 6px 20px rgba(239,68,68,0.4)}
    .btn-sm{padding:6px 14px;font-size:13px}
    input,select{width:100%;padding:12px 14px;background:var(--bg);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;transition:all 0.3s}
    input:focus,select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(59,130,246,0.2)}
    label{display:block;font-size:12px;font-weight:600;color:var(--text-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.05em}
    .grid{display:grid;gap:16px}
    .grid-2{grid-template-columns:repeat(2,1fr)}
    .grid-3{grid-template-columns:repeat(3,1fr)}
    .grid-4{grid-template-columns:repeat(4,1fr)}
    @media(max-width:1200px){.grid-2,.grid-3,.grid-4{grid-template-columns:1fr}}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
    .stat{background:linear-gradient(135deg,var(--surface-light),var(--surface));border:1px solid var(--border);border-radius:12px;padding:20px;position:relative;overflow:hidden}
    .stat::before{content:'';position:absolute;top:0;left:0;width:4px;height:100%;background:var(--primary)}
    .stat-label{font-size:12px;color:var(--text-muted);font-weight:600;text-transform:uppercase;letter-spacing:0.05em}
    .stat-value{font-size:28px;font-weight:800;margin-top:8px;font-variant-numeric:tabular-nums}
    .stat-value.editable{background:transparent;border:none;color:var(--text);padding:0;width:100%;font-size:28px;font-weight:800}
    .pill{display:inline-flex;align-items:center;justify-content:center;padding:6px 12px;border-radius:20px;font-size:13px;font-weight:700;min-width:48px;box-shadow:0 2px 8px rgba(0,0,0,0.3)}
    .cat-P{background:var(--cat-P);color:#fff}.cat-A{background:var(--cat-A);color:#fff}.cat-B{background:var(--cat-B);color:#fff}
    .cat-C{background:var(--cat-C);color:#fff}.cat-D{background:var(--cat-D);color:#fff}.cat-E{background:var(--cat-E);color:#fff}
    .cat-S{background:var(--cat-S);color:#fff}.cat-R{background:var(--cat-R);color:#fff}.cat-G{background:var(--cat-G);color:#fff}
    .cat-H{background:var(--cat-H);color:#fff}.cat-I{background:var(--cat-I);color:#fff}.cat-J{background:var(--cat-J);color:#fff}
    .cat-K{background:var(--cat-K);color:#fff}.cat-L{background:var(--cat-L);color:#fff}.cat-M{background:var(--cat-M);color:#fff}
    .cat-N{background:var(--cat-N);color:#fff}.cat-O{background:var(--cat-O);color:#fff}.cat-Q{background:var(--cat-Q);color:#fff}
    .cat-T{background:var(--cat-T);color:#fff}.cat-U{background:var(--cat-U);color:#fff}.cat-V{background:var(--cat-V);color:#fff}
    .cat-W{background:var(--cat-W);color:#fff}.cat-X{background:var(--cat-X);color:#fff}.cat-Y{background:var(--cat-Y);color:#fff}.cat-Z{background:var(--cat-Z);color:#fff}
    .cat-neutral{background:var(--surface-light);color:var(--text-muted)}
    .category-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px;transition:all 0.3s}
    .category-card:hover{border-color:var(--primary);box-shadow:0 4px 16px rgba(59,130,246,0.2)}
    .category-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .alert{background:linear-gradient(135deg,rgba(239,68,68,0.2),rgba(220,38,38,0.1));border:1px solid rgba(239,68,68,0.3);border-left:4px solid var(--danger);border-radius:12px;padding:16px 20px;margin-bottom:20px}
    .alert-title{font-weight:700;margin-bottom:8px;color:#fca5a5}
    .alert-list{padding-left:20px;line-height:1.7}
    .alert-info{background:linear-gradient(135deg,rgba(59,130,246,0.2),rgba(37,99,235,0.1));border:1px solid rgba(59,130,246,0.3);border-left:4px solid var(--primary);border-radius:12px;padding:16px 20px;margin-bottom:20px;color:var(--text)}
    .alert-warning{background:linear-gradient(135deg,rgba(245,158,11,0.2),rgba(217,119,6,0.1));border:1px solid rgba(245,158,11,0.3);border-left:4px solid var(--warning);border-radius:12px;padding:16px 20px;margin-bottom:20px;color:#fcd34d}
    table{width:100%;border-collapse:collapse}
    th,td{padding:14px;text-align:left;border-bottom:1px solid var(--border)}
    th{font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.08em;background:var(--bg)}
    tr:hover{background:var(--bg)}
    .checkbox-wrapper{display:flex;align-items:center;gap:10px;padding:12px 16px;background:var(--bg);border-radius:10px;cursor:pointer;transition:all 0.3s}
    .checkbox-wrapper:hover{background:var(--surface-light)}
    .checkbox-wrapper input[type="checkbox"]{width:20px;height:20px;cursor:pointer;accent-color:var(--primary)}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:20px}
    .chart-container{position:relative;height:400px;margin-top:20px}
    .heatmap{display:grid;grid-template-columns:60px repeat(24,1fr);gap:4px;margin-top:20px}
    .heatmap-label{display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;color:var(--text-muted)}
    .heatmap-cell{aspect-ratio:1;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;transition:all 0.3s;cursor:pointer;border:1px solid var(--border)}
    .heatmap-cell:hover{transform:scale(1.1);z-index:10;box-shadow:0 4px 12px rgba(0,0,0,0.5)}
    .week-selector{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
    .day-btn{padding:8px 16px;background:var(--surface-light);border:1px solid var(--border);border-radius:8px;color:var(--text);cursor:pointer;transition:all 0.3s;font-weight:600;font-size:13px}
    .day-btn:hover{background:var(--border)}
    .day-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .footer{text-align:center;color:var(--text-muted);font-size:13px;margin-top:40px;padding:20px}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;z-index:1000;animation:fadeIn 0.3s}
    .modal.show{display:flex}
    .modal-panel{background:var(--surface);border:1px solid var(--border);border-radius:20px;max-width:600px;width:92%;max-height:80vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.5);animation:slideUp 0.3s}
    .modal-header{background:var(--surface-light);padding:24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .modal-body{padding:24px;overflow-y:auto;max-height:calc(80vh - 80px)}
    .modal-body ul{padding-left:20px;line-height:1.8}
    .modal-body li{margin-bottom:12px}
    .modal-body strong{color:var(--primary-light)}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideUp{from{transform:translateY(30px);opacity:0}to{transform:translateY(0);opacity:1}}
    .tab-content{display:none}
    .tab-content.active{display:block}
    
    /* Styles Horloges */
    .clock-card{background:var(--bg);border:2px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px;transition:all 0.3s}
    .clock-card:hover{border-color:var(--primary);box-shadow:0 4px 16px rgba(59,130,246,0.3)}
    .clock-card.collapsed{padding:20px 20px 12px 20px}
    .clock-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px}
    .clock-card-header-left{display:flex;align-items:center;gap:12px;flex:1}
    .clock-card-header-right{display:flex;align-items:center;gap:8px}
    .clock-name{font-size:16px;font-weight:700;color:var(--text)}
    .clock-counter{background:var(--primary);color:#fff;padding:4px 12px;border-radius:20px;font-size:13px;font-weight:700;white-space:nowrap}
    .clock-toggle{background:var(--surface-light);color:var(--text);border:1px solid var(--border);padding:6px 12px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.3s;user-select:none}
    .clock-toggle:hover{background:var(--border)}
    .clock-body{transition:all 0.3s ease;overflow:hidden;opacity:1;max-height:2000px}
    .clock-body.collapsed{max-height:0;opacity:0;margin-top:0}
    .clock-sequence{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;padding:16px;background:var(--surface);border-radius:8px;min-height:60px;align-items:center}
    .sequence-item{position:relative;cursor:move;transition:border 0.2s,opacity 0.2s}
    .sequence-item.dragging{opacity:0.4}
    .sequence-item .pill{pointer-events:none}
    .sequence-item .remove-seq{position:absolute;top:-8px;right:-8px;background:var(--danger);color:#fff;border-radius:50%;width:20px;height:20px;display:none;align-items:center;justify-content:center;font-size:12px;cursor:pointer;font-weight:700;pointer-events:auto}
    .sequence-item:hover .remove-seq{display:flex}
    .clock-empty{color:var(--text-muted);font-style:italic;text-align:center;padding:20px}
    .available-cats{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .draggable-cat{cursor:grab;user-select:none}
    .draggable-cat:active{cursor:grabbing}
    .grid-schedule{display:grid;grid-template-columns:80px repeat(24,1fr);gap:2px;margin-top:16px;overflow-x:auto}
    .grid-header{position:sticky;left:0;background:var(--surface);z-index:10;font-weight:700;padding:8px;text-align:center;font-size:11px;color:var(--text-muted)}
    .grid-hour-label{background:var(--surface);padding:8px;text-align:center;font-size:10px;font-weight:600;color:var(--text-muted);position:sticky;top:0;z-index:5}
    .grid-day-label{position:sticky;left:0;background:var(--surface);z-index:10;font-weight:700;padding:8px;font-size:12px}
    .grid-cell{background:var(--bg);border:1px solid var(--border);padding:6px;min-height:40px;cursor:pointer;transition:all 0.2s;font-size:10px;font-weight:600;text-align:center;display:flex;align-items:center;justify-content:center}
    .grid-cell:hover{background:var(--surface-light);transform:scale(1.05)}
    .grid-cell.assigned{background:var(--primary);color:#fff;border-color:var(--primary-dark)}
    .positions-row{display:grid;grid-template-columns:120px 120px 1fr auto;gap:12px;align-items:center;padding:12px;background:var(--surface);border-radius:8px;margin-bottom:8px;border:1px solid var(--border)}
    .positions-label{font-weight:600;color:var(--text-muted);font-size:13px}
    .positions-badge{background:var(--primary);color:#fff;padding:6px 12px;border-radius:20px;font-weight:700;font-size:14px;text-align:center}
    .quota-regimes-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-bottom:24px}
    .quota-regime{background:var(--bg);border:2px solid var(--border);border-radius:12px;padding:12px;cursor:pointer;transition:all 0.3s;height:100%}
    .quota-regime:hover{border-color:var(--primary-light);background:var(--surface)}
    .quota-regime.selected{border-color:var(--primary);background:linear-gradient(135deg,rgba(59,130,246,0.1),rgba(37,99,235,0.05));box-shadow:0 4px 16px rgba(59,130,246,0.3)}
    .quota-regime-header{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    .quota-regime-radio{width:20px;height:20px;accent-color:var(--primary);cursor:pointer}
    .quota-regime-name{font-size:15px;font-weight:700;color:var(--text)}
    .quota-regime-desc{font-size:12px;color:var(--text-muted);margin-bottom:6px}
    .quota-regime-details{font-size:11px;color:var(--text-muted);font-style:italic;margin-bottom:4px}
    .quota-regime-examples{font-size:10px;color:var(--text-muted);opacity:0.8}
  </style>
</head>
<body>
  <div class="container" id="mainContent">
    <div class="header">
      <div class="header-content">
        <h1>üéµ Simulateur de rotations</h1>
        <div class="version" id="version">V3.0.3</div>
        <p class="subtitle">Planifie, visualise et analyse les rotations musicales avec horloges programm√©es</p>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="config">‚öôÔ∏è Configuration</button>
      <button class="tab" data-tab="clocks">üïê Horloges</button>
      <button class="tab" data-tab="quotas">üá´üá∑ Quotas fran√ßais</button>
      <button class="tab" data-tab="hourly">üìä R√©partition horaire</button>
      <button class="tab" data-tab="weekly">üìÖ Vue hebdomadaire</button>
      <button class="tab" data-tab="heatmap">üî• Heatmap de densit√©</button>
    </div>

    <!-- TAB: Configuration -->
    <div class="tab-content active" id="tab-config">
      <div class="stats">
        <div class="stat">
          <div class="stat-label">‚è±Ô∏è Heures/jour</div>
          <input class="stat-value editable" type="number" id="hoursPerDay" min="1" max="48" value="24">
        </div>
        <div class="stat">
          <div class="stat-label">üìä Total appels/jour</div>
          <div class="stat-value" id="sumCalls">0</div>
        </div>
        <div class="stat">
          <div class="stat-label">üéº Titres actifs</div>
          <div class="stat-value" id="sumTitles">0</div>
        </div>
        <div class="stat">
          <div class="stat-label">‚è≤Ô∏è Intervalle moyen</div>
          <div class="stat-value" id="globalInterval">‚Äî</div>
        </div>
        <div class="stat">
          <div class="stat-label">üá´üá∑ Quota fran√ßais</div>
          <div class="stat-value" id="homeFrenchQuota" style="font-size:32px">‚Äî</div>
        </div>
      </div>

      <div class="grid grid-2">
        <div class="card">
          <div class="card-header">
            <div class="card-title"><span>üè∑Ô∏è</span><span>Cat√©gories</span></div>
            <button class="btn btn-primary btn-sm" id="addCat">+ Ajouter</button>
          </div>
          <div class="card-body">
            <div class="toolbar">
              <button class="btn btn-secondary btn-sm" id="presetCHR">üî• Preset CHR</button>
              <button class="btn btn-secondary btn-sm" id="presetLocale">üìª Preset Locale</button>
            </div>
            <div id="categoriesContainer"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title"><span>üìà</span><span>R√©sultats & Analyse</span></div>
            <button class="btn btn-secondary btn-sm" id="exportCSV">üíæ Export CSV</button>
          </div>
          <div class="card-body">
            <div id="alertsContainer" style="margin-top:16px"></div>
            <div style="overflow-x:auto;margin-top:20px">
              <table id="resultsTable">
                <thead>
                  <tr><th>Cat√©gorie</th><th>Titres</th><th>Appels/jour</th><th>Appels/h moy.</th><th>Passages titre/heure</th><th>Intervalle</th><th>% du total</th></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="toolbar" style="justify-content:center;margin-top:20px">
        <button class="btn btn-secondary" id="exportJSON">üíæ Exporter preset</button>
        <button class="btn btn-primary" id="importJSON">üìÇ Importer preset</button>
      </div>
    </div>

    <!-- TAB: Horloges -->
    <div class="tab-content" id="tab-clocks">
      <div class="card">
        <div class="card-header">
          <div class="card-title"><span>üïê</span><span>Gestion des horloges</span></div>
          <button class="btn btn-primary btn-sm" id="addClock">+ Cr√©er une horloge</button>
        </div>
        <div class="card-body">
          <div class="alert-info">
            <strong>üí° Comment √ßa marche ?</strong><br>
            1. Cr√©ez des horloges avec des s√©quences de cat√©gories (ex: P, A, B, C)<br>
            2. Glissez-d√©posez les cat√©gories pour cr√©er votre s√©quence<br>
            3. Assignez chaque horloge √† des cr√©neaux jour/heure dans la grille ci-dessous<br>
            4. La simulation utilisera automatiquement vos horloges programm√©es
          </div>
          <div id="clocksContainer"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title"><span>‚ö°</span><span>Affectation rapide</span></div>
        </div>
        <div class="card-body">
          <p style="color:var(--text-muted);margin-bottom:16px">S√©lectionnez une horloge puis choisissez o√π l'affecter rapidement</p>
          <div style="margin-bottom:16px">
            <label>Horloge √† affecter</label>
            <select id="quickClockSelector" style="width:100%;max-width:400px">
              <option value="">-- S√©lectionner une horloge --</option>
            </select>
          </div>
          <div class="toolbar">
            <button class="btn btn-primary btn-sm" id="assignToAll">üåç Affecter √† toute la grille</button>
            <button class="btn btn-secondary btn-sm" id="assignToMonday">Lun</button>
            <button class="btn btn-secondary btn-sm" id="assignToTuesday">Mar</button>
            <button class="btn btn-secondary btn-sm" id="assignToWednesday">Mer</button>
            <button class="btn btn-secondary btn-sm" id="assignToThursday">Jeu</button>
            <button class="btn btn-secondary btn-sm" id="assignToFriday">Ven</button>
            <button class="btn btn-secondary btn-sm" id="assignToSaturday">Sam</button>
            <button class="btn btn-secondary btn-sm" id="assignToSunday">Dim</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title"><span>üìÖ</span><span>Grille d'affectation des horloges</span></div>
          <button class="btn btn-secondary btn-sm" id="clearGrid">üóëÔ∏è Tout effacer</button>
        </div>
        <div class="card-body">
          <p style="color:var(--text-muted);margin-bottom:16px">Cliquez sur une case pour assigner une horloge √† ce cr√©neau jour/heure</p>
          <div id="gridSchedule"></div>
        </div>
      </div>
    </div>

    <!-- TAB: Quotas fran√ßais -->
    <div class="tab-content" id="tab-quotas">
      <div class="card">
        <div class="card-header">
          <div class="card-title"><span>üá´üá∑</span><span>R√©gime de quota applicable</span></div>
        </div>
        <div class="card-body">
          <div class="quota-regimes-grid" id="quotaRegimeSelector"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title"><span>üá´üá∑</span><span>Calcul des quotas fran√ßais</span></div>
        </div>
        <div class="card-body">
          <p style="color:var(--text-muted);margin-bottom:24px">Heures d'√©coute significative :<br>‚Ä¢ Lun-Ven : 6h00-22h30<br>‚Ä¢ Samedi : 6h30-22h30<br>‚Ä¢ Dimanche : 7h00-22h30</p>
          
          <div class="stats">
            <div class="stat">
              <div class="stat-label">üéµ Total titres FR</div>
              <div class="stat-value" id="totalFrenchTitles">0</div>
            </div>
            <div class="stat">
              <div class="stat-label">üìª Appels FR/semaine</div>
              <div class="stat-value" id="totalFrenchCalls">0</div>
            </div>
            <div class="stat">
              <div class="stat-label">‚è∞ Appels FR (heures l√©gales)</div>
              <div class="stat-value" id="frenchCallsPeakHours">0</div>
            </div>
            <div class="stat">
              <div class="stat-label">üìä Quota atteint</div>
              <div class="stat-value" id="frenchQuotaPercent" style="font-size:36px">0%</div>
            </div>
          </div>

          <div style="margin:32px 0">
            <label style="display:block;margin-bottom:12px;font-size:14px">Conformit√© l√©gale (heures d'√©coute significative)</label>
            <div style="position:relative;height:60px;background:var(--surface-light);border-radius:12px;overflow:hidden;border:2px solid var(--border)">
              <div id="quotaGauge" style="height:100%;background:linear-gradient(90deg,#ef4444,#f59e0b,#10b981);transition:width 0.6s ease;display:flex;align-items:center;justify-content:flex-end;padding-right:16px;color:#fff;font-weight:800;font-size:20px;min-width:60px"></div>
              <div id="quotaMarkers" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none"></div>
            </div>
            <div id="quotaStatus" style="margin-top:16px;padding:16px;border-radius:10px;font-weight:600;text-align:center"></div>
          </div>

          <div class="card" style="background:var(--bg);margin-top:24px">
            <div class="card-header" style="background:var(--surface)">
              <div class="card-title">üìã D√©tail par cat√©gorie</div>
            </div>
            <div class="card-body">
              <div style="overflow-x:auto">
                <table>
                  <thead>
                    <tr><th>Cat√©gorie</th><th>Titres FR</th><th>Appels FR/semaine</th><th>Appels FR (heures l√©gales)</th><th>% de la cat√©gorie</th></tr>
                  </thead>
                  <tbody id="frenchQuotaTable"></tbody>
                </table>
              </div>
            </div>
          </div>

          <div style="margin-top:24px">
            <div class="chart-container" style="height:350px">
              <canvas id="frenchQuotaChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB: R√©partition horaire -->
    <div class="tab-content" id="tab-hourly">
      <div class="card">
        <div class="card-header"><div class="card-title">üìä R√©partition des appels par heure</div></div>
        <div class="card-body"><div class="chart-container"><canvas id="hourlyChart"></canvas></div></div>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">üéØ Distribution par cat√©gorie</div></div>
        <div class="card-body"><div class="chart-container" style="height:300px"><canvas id="pieChart"></canvas></div></div>
      </div>
    </div>

    <!-- TAB: Vue hebdomadaire -->
    <div class="tab-content" id="tab-weekly">
      <div class="card">
        <div class="card-header"><div class="card-title">üìÖ Simulation hebdomadaire</div></div>
        <div class="card-body">
          <p style="color:var(--text-muted);margin-bottom:16px">Applique tes r√®gles sur une semaine compl√®te</p>
          <div class="week-selector" id="weekSelector"></div>
          <div class="chart-container"><canvas id="weeklyChart"></canvas></div>
          <div style="margin-top:24px">
            <h3 style="margin-bottom:12px">Totaux hebdomadaires</h3>
            <div class="stats" id="weeklyStats"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB: Heatmap -->
    <div class="tab-content" id="tab-heatmap">
      <div class="card">
        <div class="card-header"><div class="card-title">üî• Heatmap de densit√© (semaine)</div></div>
        <div class="card-body">
          <p style="color:var(--text-muted);margin-bottom:16px">Intensit√© des appels par heure et par jour</p>
          <div id="heatmapContainer"></div>
        </div>
      </div>
    </div>

    <div class="footer">2025 ‚Äî Martial Demots ‚Ä¢ Spinclock V3.0.3 : Simulateur de rotations musicales</div>
  </div>

  <div class="modal" id="modal">
    <div class="modal-panel">
      <div class="modal-header">
        <strong>üìù Journal des modifications</strong>
        <button class="btn btn-secondary btn-sm" id="closeModal">Fermer</button>
      </div>
      <div class="modal-body">
        <ul>
          <li><strong>V3.0.3</strong> ‚Äî Affectation rapide d'horloges (toute la grille ou par jour), correction du bug de scroll lors de la saisie, actualisation des quotas lors du changement de r√©gime, r√©duction de la hauteur des cartes de r√©gimes.</li>
          <li><strong>V3.0.2</strong> ‚Äî Onglet renomm√© en "Horloge", compteur de titres par horloge, syst√®me d'accordion pour r√©duire/√©tendre les horloges.</li>
          <li><strong>V3.0.1</strong> ‚Äî Corrections : calculs fonctionnels sans horloges assign√©es, modal d'affectation corrig√©, presets complets, r√©gimes de quotas en grille, suppression du mot de passe.</li>
          <li><strong>V3.0.0</strong> ‚Äî Module Horloges programm√©es avec grille d'affectation 7j√ó24h. R√©gimes de quotas fran√ßais d√©taill√©s.</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="modal" id="assignModal">
    <div class="modal-panel">
      <div class="modal-header">
        <strong id="assignModalTitle">üïê Assigner une horloge</strong>
        <button class="btn btn-secondary btn-sm" onclick="closeAssignModal()">Fermer</button>
      </div>
      <div class="modal-body" id="assignModalBody"></div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded',function(){
      const q=s=>document.querySelector(s);
      const qq=s=>Array.from(document.querySelectorAll(s));
      
      function pad2(n){return String(n).padStart(2,'0')}
      function minutesToHHMM(x){if(!isFinite(x)||x<=0)return'‚Äî';const m=Math.round(x);const h=Math.floor(m/60);return h+'h'+String(m%60).padStart(2,'0')}
      function round(x,d=2){if(!isFinite(x))return 0;const p=Math.pow(10,d);return Math.round(x*p)/p}
      function firstLetterCode(code){return(code||'').toString().trim().charAt(0).toUpperCase()}
      function getCategoryColor(code){const fl=firstLetterCode(code);const colorMap={'P':'#8b5cf6','A':'#ef4444','B':'#10b981','C':'#f59e0b','D':'#ec4899','E':'#6366f1','S':'#eab308','R':'#f97316','G':'#a855f7','H':'#06b6d4','I':'#84cc16','J':'#f43f5e','K':'#8b5cf6','L':'#06b6d4','M':'#10b981','N':'#f59e0b','O':'#ec4899','Q':'#6366f1','T':'#14b8a6','U':'#f97316','V':'#a855f7','W':'#84cc16','X':'#f43f5e','Y':'#8b5cf6','Z':'#06b6d4'};return colorMap[fl]||'#64748b'}
      function generateId(){return 'id-'+Date.now()+'-'+Math.random().toString(36).substr(2,9)}
      
      const QUOTA_REGIMES = {
        general: {
          name: 'üéôÔ∏è R√©gime g√©n√©ral',
          description: 'Radios g√©n√©ralistes',
          quotaTotal: 40,
          sousQuota: 20,
          sousQuotaDesc: 'nouveaux talents/prod.',
          examples: 'NRJ, RTL2...'
        },
        jeunes: {
          name: 'üå± Jeunes talents',
          description: 'Format jeune',
          quotaTotal: 35,
          sousQuota: 25,
          sousQuotaDesc: 'nouveaux talents',
          examples: 'Fun Radio, Skyrock...'
        },
        decouverte: {
          name: 'üöÄ D√©couverte',
          description: 'Radios th√©matiques',
          quotaTotal: 15,
          sousQuota: 15,
          sousQuotaDesc: 'nouveaux talents/prod.',
          examples: 'Web-radios de niche...'
        },
        custom: {
          name: '‚öôÔ∏è Personnalis√©',
          description: 'Quota sp√©cifique',
          quotaTotal: null,
          sousQuota: null,
          sousQuotaDesc: '',
          examples: 'Accord ARCOM...'
        }
      };
      
      const state={
        hoursPerDay:24,
        categories:[],
        clocks:[],
        clockGrid:{},
        frenchQuota:{
          regime:'general',
          customPercent:40
        }
      };
      const STORAGE_KEY='rotations-sim-v3-0-3';
      
      function save(){localStorage.setItem(STORAGE_KEY,JSON.stringify(state))}
      function load(){
        const s=localStorage.getItem(STORAGE_KEY);
        if(s){
          try{
            const obj=JSON.parse(s);
            if(!obj.clocks)obj.clocks=[];
            if(!obj.clockGrid)obj.clockGrid={};
            if(!obj.frenchQuota){
              obj.frenchQuota={regime:'general',customPercent:40};
            }
            Object.assign(state,obj);
          }catch(e){}
        }
      }
      
      function renderCategories(preserveScroll=true){
        const container=q('#categoriesContainer');
        const scrollY=window.scrollY;
        const activeElement=document.activeElement;
        const activeField=activeElement?.dataset?.field;
        const activeCat=activeElement?.dataset?.cat;

        container.innerHTML='';
        if(state.categories.length===0){
          container.innerHTML='<p style="color:var(--text-muted);text-align:center;padding:20px">Aucune cat√©gorie. Cliquez sur "+ Ajouter" ou sur un preset</p>';
          q('#sumTitles').textContent='0';
          return;
        }
        state.categories.forEach((cat,catIdx)=>{
          const catCard=document.createElement('div');
          catCard.className='category-card';
          const fl=firstLetterCode(cat.code);
          const cls=fl?('cat-'+fl):'cat-neutral';
          catCard.innerHTML=`
            <div class="category-header">
              <span class="pill ${cls}">${cat.code||'‚Äî'}</span>
              <button class="btn btn-danger btn-sm" data-delete-cat="${catIdx}">üóëÔ∏è Supprimer</button>
            </div>
            <div class="grid grid-4" style="margin-bottom:16px">
              <div><label>Code cat√©gorie</label><input type="text" value="${cat.code||''}" data-cat="${catIdx}" data-field="code" placeholder="Ex: A, B, P..."></div>
              <div><label>Nombre de titres</label><input type="number" min="0" step="1" value="${cat.titles||0}" data-cat="${catIdx}" data-field="titles"></div>
              <div><label>Titres FR</label><input type="number" min="0" step="1" value="${cat.frenchTitles||0}" data-cat="${catIdx}" data-field="frenchTitles" placeholder="Nb FR"></div>
              <div><label>Couleur</label><div class="pill ${cls}" style="width:100%;cursor:default">${cat.code||'‚Äî'}</div></div>
            </div>`;
          container.appendChild(catCard);
          catCard.querySelectorAll('input[data-field]').forEach(inp=>{inp.addEventListener('input',()=>{const idx=Number(inp.dataset.cat);const field=inp.dataset.field;let val=inp.value;if(field==='titles'||field==='frenchTitles')val=Number(val||0);if(field==='frenchTitles'&&val>state.categories[idx].titles)val=state.categories[idx].titles;state.categories[idx][field]=val;save();compute();if(field==='code'){renderCategories();renderClocks();}renderResults()})});
          catCard.querySelector('[data-delete-cat]').addEventListener('click',()=>{state.categories.splice(catIdx,1);save();compute();renderCategories(false);renderResults();renderClocks()});
        });
        q('#sumTitles').textContent=state.categories.reduce((a,b)=>a+(Number(b.titles)||0),0);

        if(preserveScroll){
          requestAnimationFrame(()=>{
            window.scrollTo(0,scrollY);
            if(activeField&&activeCat){
              const inputToFocus=container.querySelector(`input[data-cat="${activeCat}"][data-field="${activeField}"]`);
              if(inputToFocus){
                inputToFocus.focus();
                if(inputToFocus.type==='text'){
                  const len=inputToFocus.value.length;
                  inputToFocus.setSelectionRange(len,len);
                }
              }
            }
          });
        }
      }
      
      function renderClocks(){
        const container=q('#clocksContainer');
        container.innerHTML='';
        if(state.clocks.length===0){
          container.innerHTML='<p style="color:var(--text-muted);text-align:center;padding:20px">Aucune horloge cr√©√©e. Cliquez sur "+ Cr√©er une horloge"</p>';
          return;
        }
        state.clocks.forEach((clock,idx)=>{
          if(clock.collapsed===undefined)clock.collapsed=false;
          const titleCount=clock.sequence.length;
          const clockCard=document.createElement('div');
          clockCard.className='clock-card'+(clock.collapsed?' collapsed':'');
          clockCard.innerHTML=`
            <div class="clock-card-header">
              <div class="clock-card-header-left">
                <input type="text" value="${clock.name||''}" placeholder="Nom de l'horloge" data-clock-name="${idx}" style="font-size:16px;font-weight:700;border:none;background:transparent;color:var(--text);padding:4px 8px;border-bottom:2px solid var(--border);width:300px">
                <div class="clock-counter">üìä ${titleCount} titre${titleCount>1?'s':''}</div>
                <button class="clock-toggle" data-toggle-clock="${idx}">${clock.collapsed?'‚ñ∂ Afficher':'‚ñº R√©duire'}</button>
              </div>
              <div class="clock-card-header-right">
                <button class="btn btn-danger btn-sm" data-delete-clock="${idx}">üóëÔ∏è Supprimer</button>
              </div>
            </div>
            <div class="clock-body${clock.collapsed?' collapsed':''}" data-clock-body="${idx}">
            <div>
              <label style="margin-bottom:8px">S√©quence des cat√©gories (glisser-d√©poser)</label>
              <div class="clock-sequence" data-sequence="${idx}" data-drop-zone="true">
                ${clock.sequence.length===0?'<div class="clock-empty">Glissez des cat√©gories ici pour cr√©er votre s√©quence</div>':''}
                ${clock.sequence.map((catCode,seqIdx)=>{
                  const fl=firstLetterCode(catCode);
                  const cls=fl?('cat-'+fl):'cat-neutral';
                  return `<div class="sequence-item" draggable="true" data-seq-idx="${seqIdx}"><span class="pill ${cls}">${catCode}</span><span class="remove-seq" data-remove-seq="${idx}-${seqIdx}">‚úï</span></div>`;
                }).join('')}
              </div>
            </div>
            <div>
              <label style="margin-top:16px;margin-bottom:8px">Cat√©gories disponibles</label>
              <div class="available-cats">
                ${state.categories.map(cat=>{
                  const fl=firstLetterCode(cat.code);
                  const cls=fl?('cat-'+fl):'cat-neutral';
                  return `<span class="pill ${cls} draggable-cat" draggable="true" data-cat-code="${cat.code}">${cat.code}</span>`;
                }).join('')}
              </div>
            </div>
            </div>`;
          container.appendChild(clockCard);
          
          clockCard.querySelector('[data-clock-name]').addEventListener('input',e=>{
            state.clocks[idx].name=e.target.value;
            save();
          });
          
          clockCard.querySelector('[data-delete-clock]').addEventListener('click',()=>{
            state.clocks.splice(idx,1);
            save();
            renderClocks();
            renderGrid();
          });

          clockCard.querySelector('[data-toggle-clock]').addEventListener('click',()=>{
            state.clocks[idx].collapsed=!state.clocks[idx].collapsed;
            save();
            renderClocks();
          });

          // Variables pour le drag & drop
          let draggedSequenceItem=null;
          let draggedFromClockIdx=null;

          clockCard.querySelectorAll('.draggable-cat').forEach(el=>{
            el.addEventListener('dragstart',e=>{
              e.dataTransfer.effectAllowed='copy';
              e.dataTransfer.setData('text/plain',el.dataset.catCode);
              e.dataTransfer.setData('source','available');
            });
          });

          // Drag and drop for sequence items (reordering)
          clockCard.querySelectorAll('.sequence-item').forEach((el,elIdx)=>{
            el.addEventListener('dragstart',e=>{
              draggedSequenceItem=parseInt(el.dataset.seqIdx);
              draggedFromClockIdx=idx;
              e.dataTransfer.effectAllowed='move';
              e.dataTransfer.setData('source','sequence');
              e.dataTransfer.setData('text/plain','sequence-move');
              setTimeout(()=>{el.classList.add('dragging')},0);
            });

            el.addEventListener('dragend',e=>{
              el.classList.remove('dragging');
              draggedSequenceItem=null;
              draggedFromClockIdx=null;
              clockCard.querySelectorAll('.sequence-item').forEach(item=>{
                item.style.borderLeft='';
                item.style.borderRight='';
                item.classList.remove('dragging');
              });
            });

            el.addEventListener('dragover',e=>{
              e.preventDefault();
              if(draggedSequenceItem!==null&&draggedFromClockIdx===idx){
                e.dataTransfer.dropEffect='move';
                const targetIdx=parseInt(el.dataset.seqIdx);
                if(draggedSequenceItem<targetIdx){
                  el.style.borderRight='3px solid var(--primary)';
                  el.style.borderLeft='';
                }else if(draggedSequenceItem>targetIdx){
                  el.style.borderLeft='3px solid var(--primary)';
                  el.style.borderRight='';
                }
              }
            });

            el.addEventListener('dragleave',e=>{
              // Nettoyer les bordures uniquement si on quitte vraiment l'√©l√©ment
              if(!el.contains(e.relatedTarget)){
                el.style.borderLeft='';
                el.style.borderRight='';
              }
            });

            el.addEventListener('drop',e=>{
              e.preventDefault();
              e.stopPropagation();

              if(draggedSequenceItem!==null&&draggedFromClockIdx===idx){
                const targetIdx=parseInt(el.dataset.seqIdx);

                if(draggedSequenceItem!==targetIdx){
                  const sequence=state.clocks[idx].sequence;
                  const draggedItem=sequence[draggedSequenceItem];

                  // Retirer l'√©l√©ment de sa position actuelle
                  sequence.splice(draggedSequenceItem,1);

                  // Calculer la nouvelle position
                  // Apr√®s suppression, si on d√©pla√ßait vers la droite, targetIdx est d√©cal√© de -1
                  const newTargetIdx=draggedSequenceItem<targetIdx?targetIdx-1:targetIdx;

                  // Ins√©rer √† la nouvelle position
                  sequence.splice(newTargetIdx,0,draggedItem);

                  save();
                  renderClocks();
                  compute();
                  renderResults();
                }
              }

              el.style.borderLeft='';
              el.style.borderRight='';
            });
          });

          const seqZone=clockCard.querySelector('[data-sequence]');
          seqZone.addEventListener('dragover',e=>{
            const source=e.dataTransfer.getData('source');
            if(source!=='sequence'||draggedSequenceItem===null){
              e.preventDefault();
              e.dataTransfer.dropEffect='copy';
            }
          });
          seqZone.addEventListener('drop',e=>{
            e.preventDefault();
            const source=e.dataTransfer.getData('source');
            if(source!=='sequence'){
              const catCode=e.dataTransfer.getData('text/plain');
              if(catCode&&catCode!=='sequence-move'){
                state.clocks[idx].sequence.push(catCode);
                save();
                renderClocks();
                compute();
                renderResults();
              }
            }
          });
          
          clockCard.querySelectorAll('[data-remove-seq]').forEach(btn=>{
            btn.addEventListener('click',()=>{
              const[clockIdx,seqIdx]=btn.dataset.removeSeq.split('-').map(Number);
              state.clocks[clockIdx].sequence.splice(seqIdx,1);
              save();
              renderClocks();
              compute();
              renderResults();
            });
          });
        });
        updateQuickClockSelector();
      }

      function updateQuickClockSelector(){
        const selector=q('#quickClockSelector');
        if(!selector)return;
        selector.innerHTML='<option value="">-- S√©lectionner une horloge --</option>';
        state.clocks.forEach(clock=>{
          const option=document.createElement('option');
          option.value=clock.id;
          option.textContent=clock.name||'Sans nom';
          selector.appendChild(option);
        });
      }

      function assignClockToDay(clockId,day){
        if(!clockId){
          alert('‚ö†Ô∏è Veuillez s√©lectionner une horloge');
          return;
        }
        for(let h=0;h<24;h++){
          const key=`${day}-${h}`;
          state.clockGrid[key]=clockId;
        }
        save();
        renderGrid();
        compute();
        renderResults();
      }

      function assignClockToAll(clockId){
        if(!clockId){
          alert('‚ö†Ô∏è Veuillez s√©lectionner une horloge');
          return;
        }
        if(!confirm('Affecter cette horloge √† toute la grille (7 jours √ó 24 heures) ?')){
          return;
        }
        for(let day=0;day<7;day++){
          for(let h=0;h<24;h++){
            const key=`${day}-${h}`;
            state.clockGrid[key]=clockId;
          }
        }
        save();
        renderGrid();
        compute();
        renderResults();
      }

      function renderGrid(){
        const container=q('#gridSchedule');
        const days=['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];
        container.innerHTML='';
        container.className='grid-schedule';

        // Build complete HTML string
        let html='<div class="grid-header">Jour / Heure</div>';
        for(let h=0;h<24;h++){
          html+=`<div class="grid-hour-label">${pad2(h)}h</div>`;
        }

        for(let day=0;day<7;day++){
          html+=`<div class="grid-day-label">${days[day]}</div>`;
          for(let hour=0;hour<24;hour++){
            const key=`${day}-${hour}`;
            const clockId=state.clockGrid[key];
            const clock=state.clocks.find(c=>c.id===clockId);
            const assigned=!!clock;
            const label=clock?clock.name.substring(0,8):'';
            html+=`<div class="grid-cell${assigned?' assigned':''}" data-day="${day}" data-hour="${hour}">${label}</div>`;
          }
        }

        container.innerHTML=html;

        // Attach event listeners after DOM is ready
        container.querySelectorAll('.grid-cell').forEach(cell=>{
          const day=parseInt(cell.dataset.day);
          const hour=parseInt(cell.dataset.hour);
          cell.addEventListener('click',()=>openAssignModal(day,hour));
        });
      }
      
      window.openAssignModal=function(day,hour){
        console.log('openAssignModal appel√©e - Jour:',day,'Heure:',hour);
        const days=['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche'];
        const modal=q('#assignModal');
        const title=q('#assignModalTitle');
        const body=q('#assignModalBody');

        console.log('Modal trouv√©:',modal);
        console.log('Nombre d\'horloges:',state.clocks.length);

        if(!modal){
          console.error('ERREUR: Le modal #assignModal n\'existe pas dans le DOM!');
          return;
        }

        title.textContent=`üïê Assigner une horloge ‚Äî ${days[day]} ${pad2(hour)}h-${pad2((hour+1)%24)}h`;

        if(state.clocks.length===0){
          body.innerHTML='<p style="color:var(--text-muted);text-align:center;padding:20px">Aucune horloge cr√©√©e. Cr√©ez d\'abord une horloge dans l\'onglet ci-dessus.</p>';
        }else{
          body.innerHTML=`
            <div style="display:flex;flex-direction:column;gap:8px">
              <button class="btn btn-secondary" onclick="assignClock(${day},${hour},null)">üóëÔ∏è Aucune (effacer)</button>
              ${state.clocks.map(c=>`<button class="btn btn-primary" onclick="assignClock(${day},${hour},'${c.id}')">${c.name||'Sans nom'}</button>`).join('')}
            </div>`;
        }

        console.log('Ajout de la classe show au modal');
        modal.classList.add('show');
        console.log('Classes du modal:',modal.className);
      };
      
      window.closeAssignModal=function(){
        q('#assignModal').classList.remove('show');
      };
      
      window.assignClock=function(day,hour,clockId){
        const key=`${day}-${hour}`;
        if(clockId===null){
          delete state.clockGrid[key];
        }else{
          state.clockGrid[key]=clockId;
        }
        save();
        renderGrid();
        compute();
        renderResults();
        closeAssignModal();
      };
      
      function renderQuotaRegimes(){
        const container=q('#quotaRegimeSelector');
        container.innerHTML='';
        Object.entries(QUOTA_REGIMES).forEach(([key,regime])=>{
          const div=document.createElement('div');
          div.className='quota-regime'+(state.frenchQuota.regime===key?' selected':'');
          div.innerHTML=`
            <div class="quota-regime-header">
              <input type="radio" name="quota-regime" value="${key}" ${state.frenchQuota.regime===key?'checked':''} class="quota-regime-radio">
              <div class="quota-regime-name">${regime.name}${regime.quotaTotal?` (${regime.quotaTotal}%)`:''}</div>
            </div>
            <div class="quota-regime-desc">${regime.description}</div>
            ${regime.sousQuota?`<div class="quota-regime-details">‚Üí ${regime.sousQuota}% ${regime.sousQuotaDesc}</div>`:''}
            ${regime.examples?`<div class="quota-regime-examples">${regime.examples}</div>`:''}
            ${key==='custom'?`<div style="margin-top:12px"><label style="text-transform:none">Quota (%)</label><input type="number" min="0" max="100" value="${state.frenchQuota.customPercent}" id="customQuotaInput" style="max-width:100px" onclick="event.stopPropagation()"></div>`:''}`;
          container.appendChild(div);
          
          div.addEventListener('click',()=>{
            state.frenchQuota.regime=key;
            save();
            renderQuotaRegimes();
            compute();
            renderResults();
            renderFrenchQuotas();
          });
        });
        
        if(q('#customQuotaInput')){
          q('#customQuotaInput').addEventListener('input',e=>{
            e.stopPropagation();
            state.frenchQuota.customPercent=Number(e.target.value)||0;
            save();
            compute();
            renderResults();
            renderFrenchQuotas();
          });
        }
      }
      
      let computed={perCat:[],sumCalls:0,globalInterval:'‚Äî',alerts:[],hourlyData:[],frenchQuotas:{totalFrenchTitles:0,totalFrenchCalls:0,frenchCallsPeakHours:0,totalCallsPeakHours:0,percentPeakHours:0,perCat:[]}};
      
      function compute(){
        const hours=Number(q('#hoursPerDay').value||24);
        state.hoursPerDay=hours;
        const alerts=[];
        const hourlyData=[];
        
        for(let h=0;h<hours;h++){
          const hourData={hour:h,categories:{},totalUsed:0};
          hourlyData.push(hourData);
        }
        
        const hasAnyAssignment=Object.keys(state.clockGrid).length>0;
        if(!hasAnyAssignment&&state.clocks.length>0){
          alerts.push({cat:'Syst√®me',message:'‚ö†Ô∏è Vous avez cr√©√© des horloges mais aucune n\'est assign√©e dans la grille. Assignez vos horloges aux cr√©neaux jour/heure pour voir les calculs.'});
        }
        
        for(let day=0;day<7;day++){
          for(let hour=0;hour<hours;hour++){
            const key=`${day}-${hour}`;
            const clockId=state.clockGrid[key];
            const clock=state.clocks.find(c=>c.id===clockId);
            const maxPositions=18;

            if(clock&&clock.sequence.length>0){
              const seqLength=clock.sequence.length;
              const callsPerCat=Math.floor(maxPositions/seqLength);
              const remainder=maxPositions%seqLength;
              
              clock.sequence.forEach((catCode,idx)=>{
                const calls=callsPerCat+(idx<remainder?1:0);
                if(!hourlyData[hour].categories[catCode])hourlyData[hour].categories[catCode]=0;
                hourlyData[hour].categories[catCode]+=calls/7;
              });
            }
          }
        }
        
        const perCat=state.categories.map(cat=>{
          let totalCallsPerDay=0;
          for(let h=0;h<hours;h++){
            totalCallsPerDay+=(hourlyData[h].categories[cat.code]||0);
          }
          const maxPossibleCalls=cat.titles*hours;
          if(totalCallsPerDay>maxPossibleCalls&&cat.titles>0){
            const deficit=totalCallsPerDay-maxPossibleCalls;
            alerts.push({cat:cat.code||'Sans code',message:`Quota impossible : ${round(totalCallsPerDay,1)} appels demand√©s mais seulement ${maxPossibleCalls} possibles (${cat.titles} titres √ó ${hours}h). D√©ficit : ${round(deficit,1)} appels.`});
          }
          const callsPerHourAvg=hours>0?totalCallsPerDay/hours:0;
          const passesPerTitlePerDay=cat.titles>0?totalCallsPerDay/cat.titles:0;
          const intervalMin=passesPerTitlePerDay>0?(60*24)/passesPerTitlePerDay:0;
          return{code:cat.code,titles:cat.titles,totalCallsPerDay,callsPerHourAvg,passesPerTitlePerDay,intervalMin};
        });
        
        const sumCalls=perCat.reduce((a,b)=>a+b.totalCallsPerDay,0);
        const intervals=perCat.filter(r=>r.passesPerTitlePerDay>0).map(r=>r.intervalMin);
        const globalInterval=intervals.length?minutesToHHMM(intervals.reduce((a,b)=>a+b,0)/intervals.length):'‚Äî';
        
        const frenchQuotas={totalFrenchTitles:0,totalFrenchCalls:0,frenchCallsPeakHours:0,totalCallsPeakHours:0,percentPeakHours:0,perCat:[]};
        state.categories.forEach(cat=>{
          frenchQuotas.totalFrenchTitles+=(cat.frenchTitles||0);
          let catFrenchCallsTotal=0;
          let catFrenchCallsPeak=0;
          let catTotalCallsPeak=0;
          const frenchRatio=(cat.titles>0&&cat.frenchTitles>0)?(cat.frenchTitles/cat.titles):0;
          
          for(let day=0;day<7;day++){
            let startHour,endHour;
            if(day>=0&&day<=4){startHour=6;endHour=22.5}
            else if(day===5){startHour=6.5;endHour=22.5}
            else{startHour=7;endHour=22.5}
            
            for(let h=0;h<hours;h++){
              const key=`${day}-${h}`;
              const clockId=state.clockGrid[key];
              const clock=state.clocks.find(c=>c.id===clockId);
              const maxPositions=18;

              let callsThisHour=0;
              if(clock&&clock.sequence.includes(cat.code)){
                const seqLength=clock.sequence.length;
                const callsPerCat=Math.floor(maxPositions/seqLength);
                const catIdx=clock.sequence.indexOf(cat.code);
                const remainder=maxPositions%seqLength;
                callsThisHour=callsPerCat+(catIdx<remainder?1:0);
              }
              
              const frenchCallsThisHour=callsThisHour*frenchRatio;
              catFrenchCallsTotal+=frenchCallsThisHour;
              
              const isPeakHour=(h>=Math.floor(startHour)&&h<Math.ceil(endHour));
              if(isPeakHour){
                catFrenchCallsPeak+=frenchCallsThisHour;
                catTotalCallsPeak+=callsThisHour;
              }
            }
          }
          
          frenchQuotas.totalFrenchCalls+=catFrenchCallsTotal;
          frenchQuotas.frenchCallsPeakHours+=catFrenchCallsPeak;
          frenchQuotas.totalCallsPeakHours+=catTotalCallsPeak;
          frenchQuotas.perCat.push({code:cat.code,frenchTitles:cat.frenchTitles||0,totalTitles:cat.titles||0,frenchCallsTotal:catFrenchCallsTotal,frenchCallsPeak:catFrenchCallsPeak,percentOfCategory:cat.titles>0?((cat.frenchTitles||0)/cat.titles*100):0});
        });
        frenchQuotas.percentPeakHours=frenchQuotas.totalCallsPeakHours>0?(frenchQuotas.frenchCallsPeakHours/frenchQuotas.totalCallsPeakHours*100):0;
        
        computed={perCat,sumCalls,globalInterval,alerts,hourlyData,frenchQuotas};
      }
      
      function renderResults(){
        q('#sumCalls').textContent=round(computed.sumCalls,2);
        q('#globalInterval').textContent=computed.globalInterval;
        
        const quotaPercent=computed.frenchQuotas?.percentPeakHours||0;
        const regime=QUOTA_REGIMES[state.frenchQuota.regime];
        const target=regime.quotaTotal||state.frenchQuota.customPercent;
        const homeQuota=q('#homeFrenchQuota');
        if(homeQuota){
          if(quotaPercent>0){
            homeQuota.textContent=round(quotaPercent,1)+'%';
            if(quotaPercent<target-5){homeQuota.style.color='#ef4444'}
            else if(quotaPercent<target){homeQuota.style.color='#f59e0b'}
            else{homeQuota.style.color='#10b981'}
          }else{
            homeQuota.textContent='‚Äî';
            homeQuota.style.color='var(--text)';
          }
        }
        
        const alertsContainer=q('#alertsContainer');
        if(computed.alerts.length>0){
          const systemAlerts=computed.alerts.filter(a=>a.cat==='Syst√®me');
          const otherAlerts=computed.alerts.filter(a=>a.cat!=='Syst√®me');
          let html='';
          if(systemAlerts.length>0){
            html+=`<div class="alert-warning"><div class="alert-title">‚ö†Ô∏è Configuration</div><ul class="alert-list">${systemAlerts.map(a=>`<li>${a.message}</li>`).join('')}</ul></div>`;
          }
          if(otherAlerts.length>0){
            html+=`<div class="alert"><div class="alert-title">‚ö†Ô∏è Alertes</div><ul class="alert-list">${otherAlerts.map(a=>`<li><strong>${a.cat}</strong> : ${a.message}</li>`).join('')}</ul></div>`;
          }
          alertsContainer.innerHTML=html;
        }else{alertsContainer.innerHTML=''}
        
        const tbody=q('#resultsTable tbody');
        tbody.innerHTML='';
        computed.perCat.forEach(r=>{
          const tr=document.createElement('tr');
          const fl=firstLetterCode(r.code);
          const cls=fl?('cat-'+fl):'cat-neutral';
          const label=r.code?r.code:'‚Äî';
          const percent=computed.sumCalls>0?(r.totalCallsPerDay/computed.sumCalls*100):0;
          tr.innerHTML=`<td><span class="pill ${cls}">${label}</span></td><td>${r.titles||0}</td><td>${round(r.totalCallsPerDay,2)}</td><td>${round(r.callsPerHourAvg,2)}</td><td>${round(r.passesPerTitlePerDay,2)}</td><td>${minutesToHHMM(r.intervalMin)}</td><td>${round(percent,1)}%</td>`;
          tbody.appendChild(tr);
        });
      }
      
      function renderFrenchQuotas(){
        q('#totalFrenchTitles').textContent=computed.frenchQuotas.totalFrenchTitles;
        q('#totalFrenchCalls').textContent=round(computed.frenchQuotas.totalFrenchCalls,1);
        q('#frenchCallsPeakHours').textContent=round(computed.frenchQuotas.frenchCallsPeakHours,1);
        const percent=computed.frenchQuotas.percentPeakHours;
        q('#frenchQuotaPercent').textContent=round(percent,1)+'%';
        
        const regime=QUOTA_REGIMES[state.frenchQuota.regime];
        const target=regime.quotaTotal||state.frenchQuota.customPercent;
        
        const gauge=q('#quotaGauge');
        gauge.style.width=Math.min(100,percent)+'%';
        gauge.textContent=round(percent,1)+'%';
        
        const markers=q('#quotaMarkers');
        markers.innerHTML='';
        [15,35,40,60].forEach(mark=>{
          if(mark<=100){
            const marker=document.createElement('div');
            marker.style.cssText=`position:absolute;left:${mark}%;top:0;bottom:0;width:${mark===target?'3px':'2px'};background:${mark===target?'rgba(255,255,255,0.8)':'rgba(255,255,255,0.3)'}`;
            markers.appendChild(marker);
            const label=document.createElement('div');
            label.style.cssText=`position:absolute;left:${mark}%;top:-24px;font-size:11px;color:var(--text-muted);transform:translateX(-50%);font-weight:${mark===target?'700':'400'}`;
            label.textContent=mark+'%';
            markers.appendChild(label);
          }
        });
        
        const status=q('#quotaStatus');
        if(percent<target-5){
          status.style.background='linear-gradient(135deg,rgba(239,68,68,0.2),rgba(220,38,38,0.1))';
          status.style.border='1px solid rgba(239,68,68,0.3)';
          status.style.color='#fca5a5';
          status.innerHTML=`‚ùå <strong>Non conforme</strong> ‚Äî En dessous du seuil ${regime.name} (${target}%)`;
        }else if(percent<target){
          status.style.background='linear-gradient(135deg,rgba(245,158,11,0.2),rgba(217,119,6,0.1))';
          status.style.border='1px solid rgba(245,158,11,0.3)';
          status.style.color='#fcd34d';
          status.innerHTML=`‚ö†Ô∏è <strong>Attention</strong> ‚Äî Proche du seuil minimum (${target}%)`;
        }else{
          status.style.background='linear-gradient(135deg,rgba(16,185,129,0.2),rgba(5,150,105,0.1))';
          status.style.border='1px solid rgba(16,185,129,0.3)';
          status.style.color='#6ee7b7';
          status.innerHTML=`‚úÖ <strong>Conforme</strong> ‚Äî ${regime.name} respect√© (‚â•${target}%)`;
        }
        
        const tbody=q('#frenchQuotaTable');
        tbody.innerHTML='';
        computed.frenchQuotas.perCat.forEach(r=>{
          const fl=firstLetterCode(r.code);
          const cls=fl?('cat-'+fl):'cat-neutral';
          const tr=document.createElement('tr');
          tr.innerHTML=`<td><span class="pill ${cls}">${r.code||'‚Äî'}</span></td><td>${r.frenchTitles}/${r.totalTitles}</td><td>${round(r.frenchCallsTotal,1)}</td><td>${round(r.frenchCallsPeak,1)}</td><td>${round(r.percentOfCategory,1)}%</td>`;
          tbody.appendChild(tr);
        });
        
        const ctx=q('#frenchQuotaChart');
        if(!ctx)return;
        if(window.frenchQuotaChart)window.frenchQuotaChart.destroy();
        const labels=Array.from({length:24},(_,i)=>`${pad2(i)}h`);
        const frenchData=[];
        const totalData=[];
        for(let h=0;h<24;h++){
          let totalFrench=0;
          let totalAll=0;
          state.categories.forEach(cat=>{
            const frenchRatio=(cat.titles>0&&cat.frenchTitles>0)?(cat.frenchTitles/cat.titles):0;
            const calls=(computed.hourlyData[h]?.categories[cat.code]||0)*7;
            totalFrench+=calls*frenchRatio;
            totalAll+=calls;
          });
          frenchData.push(totalFrench);
          totalData.push(totalAll);
        }
        window.frenchQuotaChart=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Titres fran√ßais',data:frenchData,backgroundColor:'#3b82f6',borderColor:'#2563eb',borderWidth:2},{label:'Titres internationaux',data:totalData.map((t,i)=>t-frenchData[i]),backgroundColor:'#64748b',borderColor:'#475569',borderWidth:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true,labels:{color:'#f1f5f9',font:{size:12}}},title:{display:true,text:'R√©partition fran√ßais/international par heure',color:'#f1f5f9',font:{size:16,weight:'bold'}}},scales:{x:{stacked:true,grid:{color:'#475569'},ticks:{color:'#94a3b8'}},y:{stacked:true,grid:{color:'#475569'},ticks:{color:'#94a3b8'}}}}});
      }
      
      let hourlyChart,pieChart,weeklyChart;
      function renderHourlyChart(){
        const ctx=q('#hourlyChart');
        if(!ctx)return;
        if(hourlyChart)hourlyChart.destroy();
        const labels=Array.from({length:state.hoursPerDay},(_,i)=>`${pad2(i)}h`);
        const datasets=state.categories.map(cat=>({
          label:cat.code||'Sans code',
          data:computed.hourlyData.map(h=>h.categories[cat.code]||0),
          backgroundColor:getCategoryColor(cat.code),
          borderColor:getCategoryColor(cat.code),
          borderWidth:1
        }));
        hourlyChart=new Chart(ctx,{type:'bar',data:{labels,datasets},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true,labels:{color:'#f1f5f9',font:{size:12}}},title:{display:true,text:'Appels par heure et par cat√©gorie',color:'#f1f5f9',font:{size:16,weight:'bold'}}},scales:{x:{stacked:true,grid:{color:'#475569'},ticks:{color:'#94a3b8'}},y:{stacked:true,grid:{color:'#475569'},ticks:{color:'#94a3b8'}}}}});
        
        const pieCtx=q('#pieChart');
        if(pieChart)pieChart.destroy();
        const pieData=computed.perCat.map(r=>r.totalCallsPerDay);
        const pieLabels=computed.perCat.map(r=>r.code||'Sans code');
        const pieColors=computed.perCat.map(r=>getCategoryColor(r.code));
        pieChart=new Chart(pieCtx,{type:'doughnut',data:{labels:pieLabels,datasets:[{data:pieData,backgroundColor:pieColors,borderWidth:2,borderColor:'#1e293b'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{color:'#f1f5f9',font:{size:12}}},title:{display:true,text:'Distribution des appels par cat√©gorie',color:'#f1f5f9',font:{size:16,weight:'bold'}}}}});
      }
      
      function renderWeeklyChart(){
        const days=['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche'];
        const weekSelector=q('#weekSelector');
        weekSelector.innerHTML=days.map((day,i)=>`<button class="day-btn active" data-day="${i}">${day}</button>`).join('');
        weekSelector.querySelectorAll('.day-btn').forEach(btn=>{btn.addEventListener('click',()=>{btn.classList.toggle('active');renderWeeklyChart()})});
        const activeDays=Array.from(weekSelector.querySelectorAll('.day-btn.active')).map(b=>Number(b.dataset.day));
        
        const ctx=q('#weeklyChart');
        if(!ctx)return;
        if(weeklyChart)weeklyChart.destroy();
        const datasets=state.categories.map(cat=>{
          const data=days.map((_,dayIdx)=>{
            if(!activeDays.includes(dayIdx))return 0;
            let total=0;
            for(let h=0;h<state.hoursPerDay;h++){
              const key=`${dayIdx}-${h}`;
              const clockId=state.clockGrid[key];
              const clock=state.clocks.find(c=>c.id===clockId);
              if(clock&&clock.sequence.includes(cat.code)){
                const maxPositions=18;
                const seqLength=clock.sequence.length;
                const callsPerCat=Math.floor(maxPositions/seqLength);
                const catIdx=clock.sequence.indexOf(cat.code);
                const remainder=maxPositions%seqLength;
                total+=callsPerCat+(catIdx<remainder?1:0);
              }
            }
            return total;
          });
          return{label:cat.code||'Sans code',data:data,backgroundColor:getCategoryColor(cat.code),borderColor:getCategoryColor(cat.code),borderWidth:2};
        });
        weeklyChart=new Chart(ctx,{type:'bar',data:{labels:days,datasets},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true,labels:{color:'#f1f5f9',font:{size:12}}},title:{display:true,text:'Simulation hebdomadaire',color:'#f1f5f9',font:{size:16,weight:'bold'}}},scales:{x:{stacked:true,grid:{color:'#475569'},ticks:{color:'#94a3b8'}},y:{stacked:true,grid:{color:'#475569'},ticks:{color:'#94a3b8'}}}}});
        
        const weeklyStats=q('#weeklyStats');
        let totalWeekCalls=0;
        activeDays.forEach(dayIdx=>{
          for(let h=0;h<state.hoursPerDay;h++){
            const key=`${dayIdx}-${h}`;
            const clockId=state.clockGrid[key];
            const clock=state.clocks.find(c=>c.id===clockId);
            if(clock){
              const maxPositions=18;
              totalWeekCalls+=maxPositions;
            }
          }
        });
        weeklyStats.innerHTML=`<div class="stat"><div class="stat-label">üìÖ Jours actifs</div><div class="stat-value">${activeDays.length}</div></div><div class="stat"><div class="stat-label">üìä Total appels/semaine</div><div class="stat-value">${round(totalWeekCalls,0)}</div></div><div class="stat"><div class="stat-label">üìà Moyenne/jour</div><div class="stat-value">${activeDays.length>0?round(totalWeekCalls/activeDays.length,0):0}</div></div>`;
      }
      
      function renderHeatmap(){
        const container=q('#heatmapContainer');
        if(!container)return;
        const days=['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];
        let maxCalls=0;
        days.forEach((_,dayIdx)=>{
          for(let h=0;h<24;h++){
            const key=`${dayIdx}-${h}`;
            const clockId=state.clockGrid[key];
            const clock=state.clocks.find(c=>c.id===clockId);
            if(clock){
              const maxPositions=18;
              if(maxPositions>maxCalls)maxCalls=maxPositions;
            }
          }
        });
        container.innerHTML='';
        const header=document.createElement('div');
        header.style.cssText='display:grid;grid-template-columns:60px repeat(24,1fr);gap:4px;margin-bottom:8px';
        header.innerHTML='<div class="heatmap-label"></div>'+Array.from({length:24},(_,i)=>`<div class="heatmap-label">${i}</div>`).join('');
        container.appendChild(header);
        days.forEach((day,dayIdx)=>{
          const row=document.createElement('div');
          row.className='heatmap';
          row.innerHTML=`<div class="heatmap-label">${day}</div>`;
          for(let h=0;h<24;h++){
            const key=`${dayIdx}-${h}`;
            const clockId=state.clockGrid[key];
            const clock=state.clocks.find(c=>c.id===clockId);
            let total=0;
            if(clock){
              total=18;
            }
            const intensity=maxCalls>0?total/maxCalls:0;
            const hue=200-(intensity*80);
            const sat=70+(intensity*30);
            const light=50-(intensity*20);
            const color=`hsl(${hue},${sat}%,${light}%)`;
            const cell=document.createElement('div');
            cell.className='heatmap-cell';
            cell.style.background=color;
            cell.style.color=intensity>0.5?'#fff':'#94a3b8';
            cell.textContent=total>0?round(total,0):'';
            cell.title=`${day} ${pad2(h)}h : ${round(total,1)} appels`;
            row.appendChild(cell);
          }
          container.appendChild(row);
        });
      }
      
      qq('.tab').forEach(tab=>{tab.addEventListener('click',()=>{qq('.tab').forEach(t=>t.classList.remove('active'));qq('.tab-content').forEach(tc=>tc.classList.remove('active'));tab.classList.add('active');q(`#tab-${tab.dataset.tab}`).classList.add('active');const tabId=tab.dataset.tab;if(tabId==='clocks'){renderClocks();renderGrid()}if(tabId==='quotas'){renderQuotaRegimes();renderFrenchQuotas()}if(tabId==='hourly')renderHourlyChart();if(tabId==='weekly')renderWeeklyChart();if(tabId==='heatmap')renderHeatmap()})});
      
      q('#addCat').addEventListener('click',()=>{state.categories.push({code:'',titles:0,frenchTitles:0});save();renderCategories(false);compute();renderResults();renderClocks()});
      q('#addClock').addEventListener('click',()=>{state.clocks.push({id:generateId(),name:'Nouvelle horloge',sequence:[]});save();renderClocks()});
      q('#clearGrid').addEventListener('click',()=>{if(confirm('Effacer toute la grille d\'affectation ?')){state.clockGrid={};save();renderGrid();compute();renderResults()}});

      q('#assignToAll').addEventListener('click',()=>{
        const clockId=q('#quickClockSelector').value;
        assignClockToAll(clockId);
      });
      q('#assignToMonday').addEventListener('click',()=>{
        const clockId=q('#quickClockSelector').value;
        assignClockToDay(clockId,0);
      });
      q('#assignToTuesday').addEventListener('click',()=>{
        const clockId=q('#quickClockSelector').value;
        assignClockToDay(clockId,1);
      });
      q('#assignToWednesday').addEventListener('click',()=>{
        const clockId=q('#quickClockSelector').value;
        assignClockToDay(clockId,2);
      });
      q('#assignToThursday').addEventListener('click',()=>{
        const clockId=q('#quickClockSelector').value;
        assignClockToDay(clockId,3);
      });
      q('#assignToFriday').addEventListener('click',()=>{
        const clockId=q('#quickClockSelector').value;
        assignClockToDay(clockId,4);
      });
      q('#assignToSaturday').addEventListener('click',()=>{
        const clockId=q('#quickClockSelector').value;
        assignClockToDay(clockId,5);
      });
      q('#assignToSunday').addEventListener('click',()=>{
        const clockId=q('#quickClockSelector').value;
        assignClockToDay(clockId,6);
      });

      q('#presetCHR').addEventListener('click',()=>{
        state.categories=[{code:'P',titles:15,frenchTitles:8},{code:'A',titles:20,frenchTitles:12},{code:'B',titles:25,frenchTitles:15},{code:'C',titles:30,frenchTitles:18},{code:'R',titles:50,frenchTitles:20}];
        state.clocks=[
          {id:generateId(),name:'Matinale',sequence:['P','A','B','A','P','C','B']},
          {id:generateId(),name:'Journ√©e',sequence:['A','B','C','B','A','C']},
          {id:generateId(),name:'Soir√©e',sequence:['P','A','B','R','C','B']},
          {id:generateId(),name:'Nuit',sequence:['R','C','B','R']}
        ];
        state.clockGrid={};
        const matId=state.clocks[0].id;
        const jourId=state.clocks[1].id;
        const soirId=state.clocks[2].id;
        const nuitId=state.clocks[3].id;
        for(let day=0;day<5;day++){
          for(let h=0;h<24;h++){
            if(h>=6&&h<10)state.clockGrid[`${day}-${h}`]=matId;
            else if(h>=10&&h<19)state.clockGrid[`${day}-${h}`]=jourId;
            else if(h>=19&&h<23)state.clockGrid[`${day}-${h}`]=soirId;
            else state.clockGrid[`${day}-${h}`]=nuitId;
          }
        }
        for(let day=5;day<7;day++){
          for(let h=0;h<24;h++){
            if(h>=8&&h<12)state.clockGrid[`${day}-${h}`]=matId;
            else if(h>=12&&h<20)state.clockGrid[`${day}-${h}`]=jourId;
            else state.clockGrid[`${day}-${h}`]=nuitId;
          }
        }
        save();renderCategories(false);renderClocks();renderGrid();compute();renderResults()
      });
      
      q('#presetLocale').addEventListener('click',()=>{
        state.categories=[{code:'Hits',titles:40,frenchTitles:25},{code:'Pop',titles:50,frenchTitles:30},{code:'Rock',titles:35,frenchTitles:15},{code:'Vari√©t√©',titles:45,frenchTitles:40},{code:'Oldies',titles:60,frenchTitles:35}];
        state.clocks=[
          {id:generateId(),name:'Matin',sequence:['Hits','Pop','Vari√©t√©','Pop','Hits']},
          {id:generateId(),name:'Apr√®s-midi',sequence:['Pop','Rock','Hits','Vari√©t√©','Oldies']},
          {id:generateId(),name:'Soir',sequence:['Oldies','Vari√©t√©','Pop','Rock']}
        ];
        state.clockGrid={};
        const matId=state.clocks[0].id;
        const aprId=state.clocks[1].id;
        const soirId=state.clocks[2].id;
        for(let day=0;day<7;day++){
          for(let h=0;h<24;h++){
            if(h>=6&&h<12)state.clockGrid[`${day}-${h}`]=matId;
            else if(h>=12&&h<19)state.clockGrid[`${day}-${h}`]=aprId;
            else state.clockGrid[`${day}-${h}`]=soirId;
          }
        }
        save();renderCategories(false);renderClocks();renderGrid();compute();renderResults()
      });
      
      q('#version').addEventListener('click',()=>q('#modal').classList.add('show'));
      q('#closeModal').addEventListener('click',()=>q('#modal').classList.remove('show'));
      q('#modal').addEventListener('click',e=>{if(e.target.id==='modal')q('#modal').classList.remove('show')});
      q('#assignModal').addEventListener('click',e=>{if(e.target.id==='assignModal')closeAssignModal()});
      
      q('#hoursPerDay').addEventListener('input',()=>{state.hoursPerDay=Number(q('#hoursPerDay').value||24);save();compute();renderResults()});
      
      q('#exportCSV').addEventListener('click',()=>{const headers=['Code','Nb titres','Total appels/jour','Appels/heure (moy.)','Passages titre/jour','Intervalle moyen'];const rows=computed.perCat.map(r=>[r.code||'‚Äî',r.titles||0,round(r.totalCallsPerDay,2),round(r.callsPerHourAvg,2),round(r.passesPerTitlePerDay,2),minutesToHHMM(r.intervalMin)]);const csv=[headers.join(','),...rows.map(r=>r.map(v=>`"${String(v).replaceAll('"','""')}"`).join(','))].join('\n');const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='resultats-rotations.csv';a.click();URL.revokeObjectURL(url)});
      q('#exportJSON').addEventListener('click',()=>{const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='preset-rotations-v3.json';a.click();URL.revokeObjectURL(url)});
      q('#importJSON').addEventListener('click',()=>{const inp=document.createElement('input');inp.type='file';inp.accept='.json,application/json';inp.onchange=()=>{const f=inp.files[0];const rd=new FileReader();rd.onload=()=>{try{Object.assign(state,JSON.parse(rd.result));save();renderCategories(false);renderClocks();renderGrid();renderQuotaRegimes();compute();renderResults()}catch(e){alert('‚ùå Fichier invalide')}};rd.readAsText(f)};inp.click()});
      
      load();
      renderCategories(false);
      renderClocks();
      renderGrid();
      renderQuotaRegimes();
      compute();
      renderResults();
      updateQuickClockSelector();
    });
  </script>
</body>
</html>
